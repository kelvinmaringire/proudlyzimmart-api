import{Q as b}from"./QInput-BmIudfcp.js";import{k as q,r as d,c as V,o as Q,I as R,q as C,m as S,n as U,p as r,t as T,v as n,f as t,y as k,Q as D,K as I,z}from"./index-Btp_LviN.js";import{Q as B}from"./QForm-Cgr1mS7P.js";import{Q as N}from"./QCard-eEP12_XI.js";import{Q as L}from"./QPage-M0-PEYmf.js";import{_ as K}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./use-dark-COX_BI4o.js";import"./focus-manager-BJWzFvJg.js";const M={class:"full-width q-pa-md"},j={class:"row justify-center"},A={class:"col-12 col-md-6 col-lg-4"},E={class:"text-center q-mt-lg"},F={__name:"ResetPasswordPage",setup($){const w=R(),v=C(),u=q(),a=d(""),c=d(""),l=d(""),i=d(""),p=d(""),m=d(!1),f=V(()=>u.isLoading);Q(()=>{if(w.params.key){a.value=w.params.key,console.log("Reset key from URL:",a.value);const s=a.value.split("-");if(console.log("Split parts:",s),s.length>=2){c.value=s[0];try{const o=atob(c.value.replace(/-/g,"+").replace(/_/g,"/"));console.log("User ID (decoded from uidb64):",o),console.log("uidb64 (base64-encoded):",c.value)}catch(o){console.log("Could not decode uidb64 (this is normal if format is different):",o)}l.value=s.slice(1).join("-"),console.log("Parsed uidb64:",c.value,"token:",l.value)}else l.value=a.value,console.log("Using whole key as token:",l.value)}else a.value=w.query.token||w.query.key||"",l.value=a.value,console.log("Using query param token:",l.value);!a.value&&!l.value&&(u.$q?.notify({type:"negative",message:"Invalid reset link. Please request a new password reset.",position:"top"}),v.push("/forgot-password"))});const P=async()=>{try{const s={token_key:a.value,new_password1:i.value,new_password2:p.value};console.log("Submitting password reset with data:",{resetData:s,originalKey:a.value,dataStringified:JSON.stringify(s)}),await u.confirmPasswordReset(s),setTimeout(()=>{v.push("/login")},2e3)}catch(s){console.error("Password reset error:",s);const o=s.response?.data||{},g=(o.error||o.detail||"").toLowerCase();if(g.includes("expired")||g.includes("invalid"))return;if(s.response?.status===400){console.log("token_key format failed, trying uid + token format...");try{const e={uid:c.value,token:l.value,new_password1:i.value,new_password2:p.value};console.log("Trying uid + token format (full token):",e),await u.confirmPasswordReset(e),setTimeout(()=>{v.push("/login")},2e3);return}catch(e){console.error("Format with full token failed:",e);const h=e.response?.data||{},x=(h.error||h.detail||"").toLowerCase();if(x.includes("expired")||x.includes("invalid"))return;if(a.value.includes("-")){const _=a.value.split("-");if(_.length>=2)try{const y={uid:_[0],token:_[1],new_password1:i.value,new_password2:p.value};console.log("Trying uid + token format (token part only):",y),await u.confirmPasswordReset(y),setTimeout(()=>{v.push("/login")},2e3);return}catch(y){console.error("All token formats failed:",y)}}}}}};return(s,o)=>{const g=T("router-link");return U(),S(L,{class:"flex flex-center bg-grey-1"},{default:r(()=>[n("div",M,[n("div",j,[n("div",A,[o[5]||(o[5]=n("div",{class:"text-center q-mb-lg"},[n("div",{class:"text-h5 text-weight-bold q-mb-xs"},"Reset Password"),n("div",{class:"text-grey-6"},"Enter your new password below")],-1)),t(N,{class:"q-pa-lg shadow-2",flat:""},{default:r(()=>[t(B,{onSubmit:P,class:"q-gutter-y-md"},{default:r(()=>[t(b,{modelValue:l.value,"onUpdate:modelValue":o[0]||(o[0]=e=>l.value=e),outlined:"",label:"Token",disable:!0,style:{display:"none"}},null,8,["modelValue"]),t(b,{modelValue:i.value,"onUpdate:modelValue":o[2]||(o[2]=e=>i.value=e),type:m.value?"text":"password",outlined:"",label:"New Password",placeholder:"Enter your new password",autocomplete:"new-password",rules:[e=>!!e||"Password is required",e=>e.length>=8||"Password must be at least 8 characters"],"lazy-rules":"",disable:f.value},{prepend:r(()=>[t(k,{name:"lock"})]),append:r(()=>[t(k,{name:m.value?"visibility_off":"visibility",class:"cursor-pointer",onClick:o[1]||(o[1]=e=>m.value=!m.value)},null,8,["name"])]),_:1},8,["modelValue","type","rules","disable"]),t(b,{modelValue:p.value,"onUpdate:modelValue":o[3]||(o[3]=e=>p.value=e),type:m.value?"text":"password",outlined:"",label:"Confirm Password",placeholder:"Confirm your new password",autocomplete:"new-password",rules:[e=>!!e||"Please confirm your password",e=>e===i.value||"Passwords do not match"],"lazy-rules":"",disable:f.value},{prepend:r(()=>[t(k,{name:"lock"})]),_:1},8,["modelValue","type","rules","disable"]),t(D,{type:"submit",color:"primary",class:"full-width q-mt-md",label:"Reset Password",loading:f.value},null,8,["loading"]),n("div",E,[t(g,{to:"/login",class:I(["text-primary text-weight-medium text-no-underline",{"text-grey-5":f.value}])},{default:r(()=>[t(k,{name:"arrow_back",size:"16px"}),o[4]||(o[4]=z(" Back to login ",-1))]),_:1},8,["class"])])]),_:1})]),_:1})])])])]),_:1})}}},ee=K(F,[["__scopeId","data-v-2227c4a8"]]);export{ee as default};
