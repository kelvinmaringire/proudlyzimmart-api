import{X as l,k as d,Y as r,u as p,N as n}from"./index-Btp_LviN.js";const u=l("checkout",{state:()=>({currentStep:1,shippingAddress:{full_name:"",email:"",phone:"",address_line_1:"",address_line_2:"",city:"",state:"",postal_code:"",country:"ZW",address_type:"home"},billingAddress:null,useSameBillingAddress:!0,paymentMethod:null,paymentDetails:{card_number:"",cardholder_name:"",expiry_month:"",expiry_year:"",cvv:"",mobile_money_number:"",mobile_money_provider:"",bank_name:"",account_number:""},savePaymentMethod:!1,shippingMethod:null,availableShippingMethods:[],order:null,orderId:null,promoCode:"",appliedPromoCode:null,discount:0,isLoading:!1,isSubmitting:!1,error:null,stepValidation:{shipping:!1,payment:!1,review:!1}}),getters:{isGuestCheckout:()=>!d().isAuthenticated,canProceedToPayment:e=>{const t=e.shippingAddress;return!!(t.full_name&&t.email&&t.phone&&t.address_line_1&&t.city&&t.postal_code&&t.country)},canProceedToReview:e=>{if(!e.paymentMethod)return!1;if(e.paymentMethod==="card"){const t=e.paymentDetails;return!!(t.card_number&&t.cardholder_name&&t.expiry_month&&t.expiry_year&&t.cvv)}return e.paymentMethod==="mobile_money"?!!(e.paymentDetails.mobile_money_number&&e.paymentDetails.mobile_money_provider):e.paymentMethod==="bank_transfer"?!!(e.paymentDetails.bank_name&&e.paymentDetails.account_number):!0},orderSummary:e=>{const t=p(),s=t.cartTotal,o=e.shippingMethod?.cost||0,i=s*.15,a=e.discount||0,h=s+o+i-a;return{items:t.cartItems,itemCount:t.itemCount,subtotal:s,shipping:o,tax:i,discount:a,total:h}},formattedBillingAddress:e=>e.useSameBillingAddress||!e.billingAddress?e.shippingAddress:e.billingAddress,currentStepName:e=>({1:"Shipping",2:"Payment",3:"Review",4:"Confirmation"})[e.currentStep]||"Unknown"},actions:{async initCheckout(){const e=p(),t=d();if(e.isEmpty)throw new Error("Cart is empty. Please add items to cart before checkout.");if(this.resetCheckout(),t.isAuthenticated&&t.user){const s=t.user;this.shippingAddress={...this.shippingAddress,full_name:t.fullName||s.username||"",email:s.email||"",phone:s.phone||""}}await this.loadSavedAddresses(),await this.fetchShippingMethods()},setShippingAddress(e){this.shippingAddress={...this.shippingAddress,...e},this.stepValidation.shipping=this.canProceedToPayment},setBillingAddress(e){this.billingAddress=e,this.useSameBillingAddress=!1},setPaymentMethod(e,t={}){this.paymentMethod=e,this.paymentDetails={...this.paymentDetails,...t},this.stepValidation.payment=this.canProceedToReview},setShippingMethod(e){this.shippingMethod=e},validateStep(e){switch(e){case 1:return this.canProceedToPayment;case 2:return this.canProceedToReview;case 3:return this.canProceedToReview&&this.shippingMethod;default:return!0}},proceedToNextStep(){return this.validateStep(this.currentStep)?this.currentStep<3?(this.currentStep++,!0):!1:(n.create({type:"negative",message:"Please complete all required fields before proceeding.",position:"top"}),!1)},goToStep(e){return e<this.currentStep?(this.currentStep=e,!0):this.validateStep(this.currentStep)?(this.currentStep=e,!0):!1},async fetchShippingMethods(){this.isLoading=!0,this.error=null;try{const e=await r.get("/api/checkout/shipping-methods/");this.availableShippingMethods=e.data.results||e.data||[],this.availableShippingMethods.length>0&&!this.shippingMethod&&(this.shippingMethod=this.availableShippingMethods[0])}catch(e){console.error("Error fetching shipping methods:",e),this.availableShippingMethods=[{id:"standard",name:"Standard Shipping",cost:5,estimated_days:"5-7"},{id:"express",name:"Express Shipping",cost:10,estimated_days:"2-3"}],this.shippingMethod||(this.shippingMethod=this.availableShippingMethods[0])}finally{this.isLoading=!1}},calculateShippingCost(){return this.shippingMethod&&this.shippingMethod.cost||0},async validateAddress(e){try{return(await r.post("/api/checkout/validate-address/",e)).data}catch(t){return console.error("Error validating address:",t),{valid:!0}}},async applyPromoCode(e){this.isLoading=!0,this.error=null;try{const s=(await r.post("/api/checkout/apply-promo/",{code:e.toUpperCase()})).data;if(this.appliedPromoCode=e.toUpperCase(),this.promoCode=e.toUpperCase(),s.discount_percentage){const o=p();this.discount=o.cartTotal*s.discount_percentage/100}else s.discount_amount&&(this.discount=s.discount_amount);n.create({type:"positive",message:`Promo code "${e.toUpperCase()}" applied successfully!`,position:"top"})}catch(t){this.appliedPromoCode=null,this.discount=0;const s=t.response?.data?.message||t.response?.data?.error||"Invalid promo code. Please try again.";throw n.create({type:"negative",message:s,position:"top"}),t}finally{this.isLoading=!1}},removePromoCode(){this.appliedPromoCode=null,this.promoCode="",this.discount=0},async createOrder(){if(!this.validateStep(3))throw new Error("Please complete all required information before placing order.");this.isSubmitting=!0,this.error=null;try{const e=p(),t=this.orderSummary,s={cart_items:e.cartItems.map(a=>({product_id:a.product_id||a.product?.id,quantity:a.quantity||1})),shipping_address:this.shippingAddress,billing_address:this.useSameBillingAddress?this.shippingAddress:this.billingAddress,payment_method:this.paymentMethod,payment_details:this.paymentDetails,shipping_method_id:this.shippingMethod?.id||this.shippingMethod?.name,promo_code:this.appliedPromoCode||null,subtotal:t.subtotal,shipping_cost:t.shipping,tax:t.tax,discount:t.discount,total:t.total},i=(await r.post("/api/checkout/create/",s)).data;return this.order=i,this.orderId=i.id||i.order_id||i.order_number,await e.clearCart(),this.currentStep=4,n.create({type:"positive",message:"Order placed successfully!",position:"top",timeout:3e3}),i}catch(e){throw this.error=e.response?.data?.message||e.response?.data?.error||e.message||"Failed to place order. Please try again.",n.create({type:"negative",message:this.error,position:"top",timeout:5e3}),e}finally{this.isSubmitting=!1}},async fetchOrderDetails(e){this.isLoading=!0,this.error=null;try{const t=await r.get(`/api/checkout/order/${e}/`);return this.order=t.data,this.orderId=e,t.data}catch(t){throw this.error=t.response?.data?.message||t.response?.data?.error||"Failed to load order details.",t}finally{this.isLoading=!1}},async loadSavedAddresses(){if(d().isAuthenticated)try{const t=await r.get("/api/accounts/addresses/");return t.data.results||t.data||[]}catch{return console.log("No saved addresses found or endpoint not available"),[]}},async saveAddress(e){if(d().isAuthenticated)try{return(await r.post("/api/accounts/addresses/",e)).data}catch(s){console.error("Error saving address:",s)}},resetCheckout(){this.currentStep=1,this.shippingAddress={full_name:"",email:"",phone:"",address_line_1:"",address_line_2:"",city:"",state:"",postal_code:"",country:"ZW",address_type:"home"},this.billingAddress=null,this.useSameBillingAddress=!0,this.paymentMethod=null,this.paymentDetails={card_number:"",cardholder_name:"",expiry_month:"",expiry_year:"",cvv:"",mobile_money_number:"",mobile_money_provider:"",bank_name:"",account_number:""},this.savePaymentMethod=!1,this.shippingMethod=null,this.order=null,this.orderId=null,this.promoCode="",this.appliedPromoCode=null,this.discount=0,this.error=null,this.stepValidation={shipping:!1,payment:!1,review:!1}}}});export{u};
